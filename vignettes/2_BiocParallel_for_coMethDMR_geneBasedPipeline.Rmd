---
title: "Genome-wide methylation analysis using coMethDMR via parallel computing"
author: "Gabriel J. Odom, Lissette Gomez, Lanyu Zhang and Lily Wang"
date: "9/17/2019"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: false
  pdf_document:
    toc: yes
    toc_depth: '2'
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
In the previous vignette “Introduction to **coMethDMR**”, we discussed components of the **coMethDMR** pipeline and presented example R scripts for running an analysis with **coMethDMR** serially. However, because identifying co-methylated clusters and fitting mixed effects models on large numbers of genomic regions can be computationally expensive, we illustrate implementation of parallel computing for **coMethDMR** via the **BiocParallel** R package in this vignette. 


First, we load these two packages.
```{r packLoad, message=FALSE}
library(coMethDMR)
library(BiocParallel)
```

In Section 2, we give a brief re-introduction to the example data. In Section 3, we present example scripts for analyzing a single type (e.g. genic regions) of genomic regions using parallel computing. In Section 4, we present example scripts for analyzing genic and intergenic regions on the Illumina arrays using parallel computing. 

# Example Dataset
For illustration, we use a subset of prefrontal cortex methylation data (GEO GSE59685) described in Lunnon et al. (2014). This example dataset includes beta values for 8552 CpGs on chromosome 22 for a random selection of 20 subjects. We assume quality control and normalization of the methylation dataset have been performed by R packages such as **minfi** or **RnBeads**.
```{r ex_data}
data(betaMatrixChr22_df)
betaMatrixChr22_df[1:5, 1:5]
```

The corresponding phenotype dataset included variables `stage` (Braak AD stage), `subject.id`, `Mplate` (batch effect), `sex`, `Sample` and `age.brain` (age of the brain donor). 
```{r ex_pheno_data}
data(pheno_df)
head(pheno_df)
```

Note that only samples with both methylation data and non-missing phenotype data are analyzed by **coMethDMR**. So in this example, the sample with `subject.id = 3` which lacks AD stage information will be excluded from analysis. Please also note the phenotype file needs to have a variable called "Sample" that will be used by **coMethDMR** to link to the methylation dataset. 

# Analyzing One Type of Genomic Region via BiocParallel
As mentioned previously in “Introduction to **coMethDMR**”, there are several steps in the **coMethDMR** pipeline:

1. Obtain CpGs located closely in pre-defined genomic regions,
2. Identify co-methylated regions, and
3. Test co-methylated regions against the outcome variable (AD stage).

Suppose we are interested in analyzing genic regions on the 450k arrays. In the following, `closeByGeneAll_ls` is a list, where each item includes at least 3 CpGs located closely (max distance between 2 CpGs is 200bp by default). 

```{r list_of_cgis}
closeByGeneAll_ls <- readRDS(
  system.file(
    "extdata",
    "450k_Gene_3_200.rds",
    package = 'coMethDMR',
    mustWork = TRUE
  )
)

closeByGeneAll_ls[1]
```

Next, we select regions on chromosome 22 for demonstration,. 
```{r}
indx <- grep ("chr22", names(closeByGeneAll_ls))

closeByGene_ls <- closeByGeneAll_ls[indx]
length(closeByGene_ls)

closeByGene_ls[1]

```
There are 676 genic regions to be tested for chromosome 22. 

## Compute residuals
This step removes uninteresting technical and biological effects using the `GetResiduals` function, so that the resulting co-methylated clusters are only driven by the biological factors we are interested in. 

```{r}
resid_df <- GetResiduals(
  dnam = betaMatrixChr22_df,
  betaToM = TRUE, #converts to Mvalues for fitting linear model 
  pheno_df = pheno_df,
  covariates_char = c("age.brain", "sex", "Mplate")
)
```


## Finding co-methylated regions

The cluster computing with the **BiocParallel** package involves two steps: 

1. Setting up the clusters, and 
2. Passing in the cluster as an argument to `CoMethAllRegions()`. 

First, we set up the cluster: 
```{r create_cluster}
snow_cl <- SnowParam(workers = 20, type = "SOCK")
```

Now we execute the `CoMethAllRegions()` function using each worker in the cluster, to find co-methylated clusters in the genic regions. 

```{r BiocParallel_Gene, message=FALSE}
a0 <- Sys.time()

coMeth_ls <- CoMethAllRegions(
  dnam = resid_df,
  betaToM = FALSE,
  method = "spearman",
  arrayType = "450k",
  CpGs_ls = closeByGene_ls,
  cluster = snow_cl
)
Sys.time() - a0
```

The object `coMeth_ls` is a list, with each item containing the list of CpGs within an identified co-methylated region. 

## Testing the co-methylated regions
Next we test these co-methylated regions against continuous phenotype `stage`, adjusting for covariates `age` and `sex`, by  executing the `lmmTestAllRegions()` function. 

```{r singleRegionType_lmmTest, warning=FALSE, results='hide'}
res_df <- lmmTestAllRegions(
  beta_df = betaMatrixChr22_df,
  region_ls = coMeth_ls,
  pheno_df = pheno_df,
  contPheno_char = "stage",
  covariates_char = NULL,
  modelType = "randCoef",
  arrayType = "450k",
  cluster = snow_cl, 
  outLogFile = "res_lmm_log.txt"
)
```

Model fit messages and diagnostics for each region will be saved to the log file specified with the `outLogFile` argument. For a single region, this will return a one row of model fit statistics similar to the following:

| chrom |    start |      end | nCpGs | Estimate | StdErr |    Stat | pValue |
|-------|----------|----------|-------|----------|--------|---------|--------|
| chr22 | 24823455 | 24823519 |      4|  -0.0702 | 0.0290 | -2.4184 | 0.0155 |

<!-- Because the linear mixed model may fail to converge in some cases, we want to record the computational logs from the parallel workers. To do this, we add additional information to the clusters. -->
<!-- ```{r add_BP_log, eval=FALSE} -->
<!-- snow_cl <- SnowParam(workers = 8, type = "SOCK") -->
<!-- register(snow_cl) -->

<!-- bplog(snow_cl) <- TRUE -->

<!-- dirName <- paste0("lmm_results_log_", Sys.Date(), "/") -->
<!-- dir.create(dirName) -->
<!-- bplogdir(snow_cl) <- dirName -->
<!-- ``` -->

# coMethDMR Analysis Pipeline for 450k Methylation Arrays Datasets via BiocParallel

In this section, we provide example scripts for testing genic and intergenic regions using **coMethDMR** and **BiocParallel** R packages. 

Same as before, first, we create the clusters of workers. 
```{r cluster_2, eval=FALSE}
snow_cl <- SnowParam(workers = 20, type = "SOCK")
```

First, we read in clusters of CpGs located closely on the array, in genic and intergenic regions. 

```{r}
# closeByGene_ls <- readRDS(
#   system.file(
#     "extdata",
#     "450k_Gene_3_200.RDS",
#     package = 'coMethDMR',
#     mustWork = TRUE
#   )
# )
# 
# closeByInterGene_ls <- readRDS(
#   system.file(
#     "extdata",
#     "Inter_Gene_3_200,RDS",
#     package = 'coMethDMR',
#     mustWork = TRUE
#   )
# )

# < this will be changed once package datasets are updated
closeByGene_ls <- readRDS ("C:/Users/lxw391/Dropbox (BBSR)/GabrielOdom/coMethDMR/LWtest/450k_Gene_3_200.RDS")

closeByInterGene_ls <- readRDS ("C:/Users/lxw391/Dropbox (BBSR)/GabrielOdom/coMethDMR/LWtest/450k_InterGene_3_200.RDS")

# put them together in one list
closeBy_ls <- c(closeByGene_ls, closeByInterGene_ls)

# select regions on chrom 22 for demonstration
indx <- grep ("chr22", names(closeBy_ls))

closeByChr22_ls <- closeBy_ls[indx]
length(closeByChr22_ls)

closeByChr22_ls[1]

```

Next we remove uninteresting biological and technical effects, execute the `CoMethAllRegions()` function over each worker on the cluster (this completes in roughly xx minutes using 20 cores and 64Gb of RAM), then pass these results to `lmmTestAllRegions()`:
```{r loop_over_region_types, eval=TRUE}
aAll <- Sys.time()

residChr22_df <- GetResiduals(
  dnam = betaMatrixChr22_df,
  betaToM = TRUE, #converts to Mvalues for fitting linear model 
  pheno_df = pheno_df,
  covariates_char = c("age.brain", "sex", "Mplate")
)

coMethChr22_ls <- CoMethAllRegions(
    dnam = residChr22_df,
    method = "spearman",
    arrayType = "450k",
    CpGs_ls = closeByChr22_ls,
    cluster = snow_cl
)
  
resChr22_df <- lmmTestAllRegions(
    beta_df = betaMatrixChr22_df,
    region_ls = coMethChr22_ls,
    pheno_df = pheno_df,
    contPheno_char = "stage",
    covariates_char = c("age.brain", "sex", "Mplate"),
    modelType = "randCoef",
    arrayType = "450k",
    cluster = snow_cl, 
    outLogFile = paste0("lmm_log.txt")
  )

Sys.time() - aAll
```

## Annotate results
Finally, we can annotate the results using the `AnnotateResults()` function.
```{r annotate_results}
lmmResAnnotatedChr22_df <- AnnotateResults(
  lmmRes_df = resChr22_df,
  arrayType = "450k"
)
head(lmmResAnnotatedChr22_df)
```

# Implementing Parallel Computing for coMethDMR Analysis of EPIC Methylation Arrays Datasets 

The analysis for EPIC methylation arrays would be the same as those for 450k arrays, except by testing genomic regions in files "EPIC_Gene_3_200.RDS" and "EPIC_InterGene_3_200.RDS", instead of "450k_Gene_3_200.RDS" and "450k_InterGene_3_200,RDS". 

So the following scripts replace those in Section xxx. 

```{r}
# closeByGene_ls <- readRDS(
#   system.file(
#     "extdata",
#     "450k_Gene_3_200.RDS",
#     package = 'coMethDMR',
#     mustWork = TRUE
#   )
# )
# 
# closeByInterGene_ls <- readRDS(
#   system.file(
#     "extdata",
#     "InterGene_3_200,RDS",
#     package = 'coMethDMR',
#     mustWork = TRUE
#   )
# )
```


# Additional Comments on Computational Time and Resources
In this vignette, we have analyzed a small subset of a real EWAS dataset (i.e. only chromosome 22 data on 20 subjects). To give users a more realistic estimate of time for analyzing real EWAS datasets, we also measured time used for analyzing the entire Lunnon et al. (2014) dataset with 110 samples on all chromosomes. These computation times measured on a Dell Precision 5810 with 64Gb of RAM, an Intel Xeon E5-2640 CPU at 2.40Ghz, and using up to 20 cores. More specifically, in Section 4, the entire **coMethDMR** workflow for took xxx minutes with xxx cores and used 24Gb of RAM. We’re currently working improving the speed and reducing the size of **coMethDMR**, so please check back soon for updates.  
